local MacLib = loadstring(game:HttpGet("https://github.com/biggaboy212/Maclib/releases/latest/download/maclib.txt"))()

-- Deklarasi service dan variabel utama (tidak diubah) jangan di ubah ubah sama sekali
local workspace = workspace
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local hrp = character:WaitForChild("HumanoidRootPart")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local LocalPlayer = player -- alias supaya sama dengan LocalPlayer

local camera = workspace.CurrentCamera
local screenSize = camera.ViewportSize

local Window = MacLib:Window({
    Title = "Nexa | Premium",
    Subtitle = "Fish It | V0.0.0",
    Size = UDim2.fromOffset(720, 410),
    DragStyle = 1,
    DisabledWindowControls = {},
    ShowUserInfo = false,
    Keybind = Enum.KeyCode.RightControl,
    AcrylicBlur = true,
})

local cg = game:GetService("CoreGui")

task.spawn(function()
    while true do
        for _, obj in ipairs(cg:GetDescendants()) do
            if obj.Name == "UserInfo" then
                obj:Destroy()
            end
        end
        task.wait(1)
    end
end)

local tabGroups = {
	TabGroup1 = Window:TabGroup()
}

local tabs = {
	Fishing = tabGroups.TabGroup1:Tab({ Name = "Fishing", Image = "rbxassetid://97899956724998" }),
	Quest = tabGroups.TabGroup1:Tab({ Name = "Quest", Image = "rbxassetid://10734950309" })
}

local sections = {
	Fishing = tabs.Fishing:Section({ Side = "Left" }),
    Fishing1 = tabs.Fishing:Section({ Side = "Right" }),
    Quest = tabs.Quest:Section({ Side = "Left" }),
    Quest1 = tabs.Quest:Section({ Side = "Right" }),
}

sections.Fishing:Header({
	Name = "Fishing Feature"
})

local FishingController = require(ReplicatedStorage.Controllers.FishingController)
local AutoFishingController = require(ReplicatedStorage.Controllers.AutoFishingController)
local Replion = require(ReplicatedStorage.Packages.Replion)

-- STATE
local AutoFishState = {
	IsActive = false,
	MinigameActive = false
}

local ClickSpeed = 0.05

-- CLICK FUNCTION
local function performClick()
	FishingController:RequestFishingMinigameClick()
	task.wait(ClickSpeed + math.random() * ClickSpeed)
end

-- FORCE AUTOFISH ALWAYS ON
local originalAutoFishingStateChanged = AutoFishingController.AutoFishingStateChanged
AutoFishingController.AutoFishingStateChanged = function(...)
	return originalAutoFishingStateChanged(true)
end

-- FORCE SERVER AUTO FISHING ON
local function ensureServerAutoFishingOn()
	local replionData = Replion.Client:WaitReplion("Data")
	local currentAutoFishingState = replionData:GetExpect("AutoFishing")

	if not currentAutoFishingState then
		local Net = require(ReplicatedStorage.Packages.Net)
		local UpdateAutoFishingRemote = Net:RemoteFunction("UpdateAutoFishingState")

		pcall(function()
			UpdateAutoFishingRemote:InvokeServer(true)
		end)
	end
end

-- HOOK MINIGAME
local originalRodStarted = FishingController.FishingRodStarted
local originalFishingStopped = FishingController.FishingStopped

local clickThread = nil

FishingController.FishingRodStarted = function(self, ...)
	originalRodStarted(self, ...)

	if AutoFishState.IsActive and not AutoFishState.MinigameActive then
		AutoFishState.MinigameActive = true

		if clickThread then task.cancel(clickThread) end

		clickThread = task.spawn(function()
			while AutoFishState.IsActive and AutoFishState.MinigameActive do
				performClick()
			end
		end)
	end
end

FishingController.FishingStopped = function(self, ...)
	originalFishingStopped(self, ...)

	if AutoFishState.MinigameActive then
		AutoFishState.MinigameActive = false
		task.wait(1)
		ensureServerAutoFishingOn()
	end
end

-- TOGGLE
local function ToggleAutoClick(shouldActivate)
	AutoFishState.IsActive = shouldActivate

	if shouldActivate then
		ensureServerAutoFishingOn()
	else
		if clickThread then
			task.cancel(clickThread)
			clickThread = nil
		end

		AutoFishState.MinigameActive = false
	end
end

-- =====================================================================
--  UI (FORMAT BARU)
-- =====================================================================

sections.Fishing:Toggle({
	Name = "Auto Fish Legit",
	Default = false,
	Callback = function(value)
		ToggleAutoClick(value)

		Window:Notify({
			Title = "Auto Fish Legit",
			Description = (value and "Enabled " or "Disabled ") .. "Auto Fish"
		})
	end,
}, "AutoFishToggle")

sections.Fishing:Input({
	Name = "Click Speed",
	Placeholder = "Default: 0.05",
	AcceptedCharacters = "Numbers",
	Callback = function(value)
		local num = tonumber(value)

		if num and num > 0 then
			ClickSpeed = num
			Window:Notify({
				Title = "Speed",
				Description = "Click Speed set to: " .. num
			})
		end
	end,
}, "AutoFishSpeed")

sections.Fishing:Toggle({
	Name = "Show Fishing Counter Gui",
	Default = false,
	Callback = function(state)
		local fishingCounterGui = player.PlayerGui:FindFirstChild("FishingCounterGui")

		if fishingCounterGui then
			fishingCounterGui.Enabled = state
		else
			warn("FishingCounterGui not found!")
		end
	end,
}, "ShowFishingCounterGuiToggle")

local stopAnimConnections = {}

local function setGameAnimationsEnabled(state)
    local character = player.Character or player.CharacterAdded:Wait()
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if not humanoid then
        return
    end

    -- Bersihkan koneksi animasi lama
    for _, conn in ipairs(stopAnimConnections) do
        conn:Disconnect()
    end
    stopAnimConnections = {}

    if state then
        -- Hentikan semua animasi yg sedang berjalan
        local animator = humanoid:FindFirstChildOfClass("Animator")
        if animator then
            for _, track in ipairs(animator:GetPlayingAnimationTracks()) do
                track:Stop(0)
            end

            -- Cegah animasi baru dimainkan
            local conn = animator.AnimationPlayed:Connect(function(track)
                task.defer(function()
                    track:Stop(0)
                end)
            end)
            table.insert(stopAnimConnections, conn)
        end
    else
        -- Re-enable: cukup matikan koneksi
        for _, conn in ipairs(stopAnimConnections) do
            conn:Disconnect()
        end
        stopAnimConnections = {}
    end

    -- Notify WindUI
    Window:Notify({
        Title = "No Animation",
        Description = (state and "Enabled " or "Disabled ") .. "No Animation"
    })
end

-- =====================================================================
-- Toggle WindUI (Format Baru)
-- =====================================================================

sections.Fishing:Toggle({
    Name = "No Animation",
    Default = false,
    Callback = function(state)
        setGameAnimationsEnabled(state)
    end,
})

-- Ambil RemoteFunction CancelFishing
local CancelFishing = ReplicatedStorage
    :WaitForChild("Packages")
    :WaitForChild("_Index")
    :WaitForChild("sleitnick_net@0.2.0")
    :WaitForChild("net")
    :WaitForChild("RF/CancelFishingInputs")

-- Button Baru Format sections.Fishing
sections.Fishing:Button({
	Name = "Cancel Fishing",
	Callback = function()
		CancelFishing:InvokeServer()
	end,
})


sections.Fishing:Header({
	Name = "Instant Fishing Feature"
})

-- Services (Players & ReplicatedStorage sudah didefinisikan tadi)
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()

-- Remotes
local ChargeFishingRod = ReplicatedStorage.Packages._Index["sleitnick_net@0.2.0"].net["RF/ChargeFishingRod"]
local RequestFishingMinigameStarted = ReplicatedStorage.Packages._Index["sleitnick_net@0.2.0"].net["RF/RequestFishingMinigameStarted"]
local REReplicateTextEffect = ReplicatedStorage.Packages._Index["sleitnick_net@0.2.0"].net["RE/ReplicateTextEffect"]
local REFishingCompleted = ReplicatedStorage.Packages._Index["sleitnick_net@0.2.0"].net["RE/FishingCompleted"]

-- Step 2 args
local miniggameArgs = {
    -1.233184814453125,
    0.9972056628181873,
    1763291794.158201
}

-- Flags
local isFishing = false
local autoFishingEnabled = false

-- Delay Values
local castDelay = 1.5
local completedDelay = 1

-- Safe Wait
local function SafeWait(t)
    local start = os.clock()
    while os.clock() - start < t do
        if not autoFishingEnabled then return false end
        task.wait()
    end
    return true
end

-- Start Fishing Cycle
local function StartFishingCycle()
    if not autoFishingEnabled then return end
    if isFishing then return end

    isFishing = true

    ChargeFishingRod:InvokeServer()
    if not SafeWait(0.2) then return end

    RequestFishingMinigameStarted:InvokeServer(unpack(miniggameArgs))
end

-- Detect "!" (minigame completed)
REReplicateTextEffect.OnClientEvent:Connect(function(data)
    if not autoFishingEnabled then return end
    if not data or not data.TextData then return end

    local attach = data.TextData.AttachTo
    if not attach or not attach.Parent then return end

    local character = attach.Parent
    local player = Players:GetPlayerFromCharacter(character)
    if player ~= LocalPlayer then return end

    task.spawn(function()
        if not SafeWait(tonumber(completedDelay) or 1) then return end
        REFishingCompleted:FireServer()
        isFishing = false

        if not SafeWait(tonumber(castDelay) or 1.5) then return end
        StartFishingCycle()
    end)
end)

-- ============================================================
--  UI BARU (FORMAT SECTIONS.Fishing)
-- ============================================================

sections.Fishing:Toggle({
	Name = "Instant Fishing",
	Default = false,
	Callback = function(state)
		autoFishingEnabled = state

        if state then
            StartFishingCycle()
        else
            isFishing = false
        end

		Window:Notify({
			Title = "Instant Fishing",
			Description = (state and "Enabled" or "Disabled") .. " Instant Fishing"
		})
	end,
}, "InstantFishingToggle")


sections.Fishing:Input({
	Name = "Cast Delay",
	Placeholder = "Default: 1.5",
	AcceptedCharacters = "Numbers",
	Callback = function(input)
		castDelay = tonumber(input) or 1.5
		Window:Notify({
			Title = "Cast Delay",
			Description = "Cast Delay set to: " .. tostring(castDelay)
		})
	end,
}, "InstantFishingCastDelay")


sections.Fishing:Input({
	Name = "Completed Delay",
	Placeholder = "Default: 1",
	AcceptedCharacters = "Numbers",
	Callback = function(input)
		completedDelay = tonumber(input) or 1
		Window:Notify({
			Title = "Completed Delay",
			Description = "Completed Delay set to: " .. tostring(completedDelay)
		})
	end,
}, "InstantFishingCompletedDelay")

sections.Fishing1:Header({
	Name = "Equipment Feature"
})

-- Module
local Net = require(ReplicatedStorage.Packages.Net)
local Replion = require(ReplicatedStorage.Packages.Replion).Client

-- RemoteEvent EquipItem
local EquipItemEvent = Net:RemoteEvent("EquipItem")

-- Data player
local data = Replion:WaitReplion("Data")

-- Variabel untuk menyimpan nama rod yang dipilih
local SelectedRodName = "Starter Rod"

-- Dropdown baru (format sections)
sections.Fishing1:Dropdown({
	Name = "Select Rod",
	Search = true,
	Multi = false,
	Options = {
		"Starter Rod",
		"Luck Rod",
		"Carbon Rod",
		"Grass Rod",
		"Demascus Rod",
		"Ice Rod",
		"Lucky Rod",
		"Midnight Rod",
		"Steampunk Rod",
		"Chrome Rod",
		"Fluorescent Rod",
		"Astral Rod",
		"Angler Rod",
		"Ares Rod",
		"Bamboo Rod",
		"Toy Rod",
		"Lava Rod",
		"Hazmat Rod",
		"Ghostfinn Rod",
		"Element Rod",
		"Angelic Rod",
		"Gold Rod",
		"Hyper Rod"
	},
	Default = "Starter Rod",
	Callback = function(Value)
		SelectedRodName = Value
	end,
}, "RodDropdown")


-- Button baru (format sections)
sections.Fishing1:Button({
	Name = "Equip Selected Rod",
	Callback = function()

		local RodIDs = {
			["Starter Rod"] = 1,
			["Luck Rod"] = 79,
			["Carbon Rod"] = 76,
			["Grass Rod"] = 85,
			["Demascus Rod"] = 77,
			["Ice Rod"] = 78,
			["Lucky Rod"] = 4,
			["Midnight Rod"] = 80,
			["Steampunk Rod"] = 6,
			["Chrome Rod"] = 7,
			["Fluorescent Rod"] = 255,
			["Astral Rod"] = 5,
			["Angler Rod"] = 168,
			["Ares Rod"] = 126,
			["Bamboo Rod"] = 258,
			["Toy Rod"] = 84,
			["Lava Rod"] = 2,
			["Hazmat Rod"] = 256,
			["Ghostfinn Rod"] = 169,
			["Element Rod"] = 257,
			["Angelic Rod"] = 124,
			["Gold Rod"] = 8,
			["Hyper Rod"] = 9
		}

		local selectedID = RodIDs[SelectedRodName]
		if not selectedID then return end

		local rods = data:GetExpect({"Inventory", "Fishing Rods"})
		if not rods then return end

		for _, rod in ipairs(rods) do
			if rod and rod.Id == selectedID then
				EquipItemEvent:FireServer(rod.UUID, "Fishing Rods")
				break
			end
		end
	end,
})

-- RemoteEvent EquipBait
local equipBaitRemote = ReplicatedStorage
    :WaitForChild("Packages")
    :WaitForChild("_Index")
    :WaitForChild("sleitnick_net@0.2.0")
    :WaitForChild("net")
    :WaitForChild("RE/EquipBait")

local selectedID = nil

-- Dropdown pilih Bait (UI Baru)
sections.Fishing1:Dropdown({
    Name = "Select Bait",
    Options = {
        "Starter Bait",
        "Topwater Bait",
        "Luck Bait",
        "Midnight Bait",
        "Nature Bait",
        "Chroma Bait",
        "Royal Bait",
        "Dark Matter Bait",
        "Corrupt Bait",
        "Aether Bait",
        "Floral Bait",
        "Singularity Bait",
        "Beach Ball Bait",
        "Gold Bait",
        "Hyper Bait"
    },
    Default = "Starter Bait",
    Search = true,

    Callback = function(selected)
        local BobberIDs = {
            ["Starter Bait"] = 1,
            ["Luck Bait"] = 2,
            ["Gold Bait"] = 4,
            ["Hyper Bait"] = 5,
            ["Chroma Bait"] = 6,
            ["Dark Matter Bait"] = 8,
            ["Beach Ball Bait"] = 9,
            ["Topwater Bait"] = 10,
            ["Corrupt Bait"] = 15,
            ["Aether Bait"] = 16,
            ["Nature Bait"] = 17,
            ["Singularity Bait"] = 18,
            ["Royal Bait"] = 19,
            ["Floral Bait"] = 20,
        }

        selectedID = BobberIDs[selected]
    end,
})

-- Tombol Equip Bait (UI Baru)
sections.Fishing1:Button({
	Name = "Equip Selected Bait",
	Callback = function()
		if selectedID then
			equipBaitRemote:FireServer(selectedID)
		end
	end,
})

-- Ambil RemoteEvent untuk equip rod
local netEvent = ReplicatedStorage:WaitForChild("Packages")
    :WaitForChild("_Index")
    :WaitForChild("sleitnick_net@0.2.0")
    :WaitForChild("net")
    :WaitForChild("RE/EquipToolFromHotbar")

local args = {1}

local autoEquipRod = false

-- Toggle Baru
sections.Fishing1:Toggle({
    Name = "Auto Equip Rod",
    Default = false,
    Callback = function(state)
        autoEquipRod = state
    end,
})

-- Loop Auto Equip
task.spawn(function()
    while true do
        if autoEquipRod then
            netEvent:FireServer(unpack(args))
        end
        task.wait(1)
    end
end)

sections.Fishing1:Header({
	Name = "Sell Feature"
})

local LocalPlayer = Players.LocalPlayer
local sellRemote = ReplicatedStorage:WaitForChild("Packages")
    :WaitForChild("_Index")
    :WaitForChild("sleitnick_net@0.2.0")
    :WaitForChild("net")
    :WaitForChild("RF/SellAllItems")

local autoSell = false
local sellDelay = 2
local mode = "Sell Delay"
local autoSellLoop = nil

-- Slider Delay Jual Otomatis
sections.Fishing1:Slider({
	Name = "Sell Delay (seconds)",
	Default = 2,
	Min = 1,
	Max = 100,
	Rounding = 0,
	Callback = function(value)
		sellDelay = value
	end,
}, "SellDelaySlider")

-- Dropdown Mode Auto Sell
sections.Fishing1:Dropdown({
	Name = "Select Mode",
	Options = { "Backpack Full", "Sell Delay" },
	Default = "Sell Delay",
	Multi = false,
	Search = false,
	MaxVisibleDropdownItems = 5,
	Callback = function(option)
		mode = option
	end,
}, "SellModeDropdown")

-- Toggle Auto Sell
sections.Fishing1:Toggle({
	Name = "Auto Sell All Items",
	Default = false,
	Callback = function(state)
		autoSell = state

		if state then
			autoSellLoop = task.spawn(function()
				while autoSell do
					pcall(function()
						if mode == "Sell Delay" then
							sellRemote:InvokeServer()
							task.wait(sellDelay)
						elseif mode == "Backpack Full" then
							local bagLabel = LocalPlayer
								.PlayerGui
								.Inventory
								.Main
								.Top
								.Options
								.Fish
								.Label
								.BagSize

							if bagLabel and bagLabel.Text == "4,500/4,500" then
								sellRemote:InvokeServer()
							end
							task.wait(1)
						end
					end)
				end
			end)
		else
			if autoSellLoop then
				task.cancel(autoSellLoop)
				autoSellLoop = nil
			end
		end
	end,
}, "AutoSellToggle")


sections.Quest:Header({
	Name = "Sell Feature"
})

local board = workspace["!!! MENU RINGS"]["Deep Sea Tracker"].Board
local surfaceGui = board:WaitForChild("Gui")
local content = surfaceGui:WaitForChild("Content")
local labelNames = {"Label1", "Label2", "Label3", "Label4"}

-- Buat label Paragraph baru dengan header dan isi default
local deepSeaParagraph = sections.Quest:Paragraph({
	Header = "Deep Sea Quest Status",
	Body = "Checking..."
}, "DeepSeaQuestParagraph")

local function updateDeepSea()
	local lines = {}
	for _, name in ipairs(labelNames) do
		local label = content:FindFirstChild(name)
		if label then
			table.insert(lines, label.Text)
		end
	end
	local newText = table.concat(lines, "\n")
	deepSeaParagraph:SetBody(newText)
end

updateDeepSea()

for _, name in ipairs(labelNames) do
	local label = content:FindFirstChild(name)
	if label then
		label:GetPropertyChangedSignal("Text"):Connect(updateDeepSea)
	end
end

local TweenService = game:GetService("TweenService")
local UIS = game:GetService("UserInputService")
local player = game.Players.LocalPlayer

--======================================================
-- SCREEN GUI
--======================================================
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "NexaUIToggle"
ScreenGui.IgnoreGuiInset = true
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = player:WaitForChild("PlayerGui")

--======================================================
-- FRAME KOTAK (WARNA BIRU SEPERTI FOTO)
--======================================================
local ToggleFrame = Instance.new("Frame")
ToggleFrame.Parent = ScreenGui
ToggleFrame.Size = UDim2.new(0, 70, 0, 70)
ToggleFrame.Position = UDim2.new(0, 100, 0, 150)
ToggleFrame.BackgroundColor3 = Color3.fromRGB(20, 80, 200)
ToggleFrame.BorderSizePixel = 0

local Corner = Instance.new("UICorner")
Corner.CornerRadius = UDim.new(0, 14)
Corner.Parent = ToggleFrame

-- GRADIENT BIRU
local Gradient = Instance.new("UIGradient")
Gradient.Color = ColorSequence.new({
    ColorSequenceKeypoint.new(0, Color3.fromRGB(36, 112, 255)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(0, 42, 130))
})
Gradient.Rotation = 45
Gradient.Parent = ToggleFrame

-- GLOW BIRU SOFT
local Glow = Instance.new("ImageLabel")
Glow.Parent = ToggleFrame
Glow.Size = UDim2.new(1.7, 0, 1.7, 0)
Glow.Position = UDim2.new(0.5, 0, 0.5, 0)
Glow.AnchorPoint = Vector2.new(0.5, 0.5)
Glow.BackgroundTransparency = 1
Glow.Image = "rbxassetid://12171505282" -- soft radial glow
Glow.ImageColor3 = Color3.fromRGB(0, 153, 255)
Glow.ImageTransparency = 0.35

-- BORDER HALUS
local Stroke = Instance.new("UIStroke")
Stroke.Parent = ToggleFrame
Stroke.Thickness = 2
Stroke.Color = Color3.fromRGB(140, 200, 255)
Stroke.Transparency = 0.25

--======================================================
-- IMAGE BUTTON
--======================================================
local ToggleBtn = Instance.new("ImageButton")
ToggleBtn.Parent = ToggleFrame
ToggleBtn.Size = UDim2.new(0, 60, 0, 60)
ToggleBtn.Position = UDim2.new(0.5, -30, 0.5, -30)
ToggleBtn.BackgroundTransparency = 1
ToggleBtn.Image = "rbxassetid://123906607434048"

--======================================================
-- STATE UITOGGLE
--======================================================
local uiVisible = true

ToggleBtn.MouseButton1Click:Connect(function()

    -- shrink
    TweenService:Create(ToggleBtn, TweenInfo.new(0.08), {
        Size = UDim2.new(0, 52, 0, 52)
    }):Play()

    task.wait(0.08)

    -- expand
    TweenService:Create(ToggleBtn, TweenInfo.new(0.12), {
        Size = UDim2.new(0, 60, 0, 60)
    }):Play()

    uiVisible = not uiVisible

    if Window and Window.SetState then
        Window:SetState(uiVisible)
    else
        warn("Window:SetState tidak ditemukan")
    end    
end)

--======================================================
-- UNIVERSAL DRAG SYSTEM
--======================================================
local dragging = false
local dragStart
local startPos

local function beginDrag(input)
    dragging = true
    dragStart = input.Position
    startPos = ToggleFrame.Position
end

local function updateDrag(input)
    local delta = input.Position - dragStart
    ToggleFrame.Position = UDim2.new(
        startPos.X.Scale,
        startPos.X.Offset + delta.X,
        startPos.Y.Scale,
        startPos.Y.Offset + delta.Y
    )
end

local function endDrag()
    dragging = false
end

-- Bisa ditarik dari Frame & Button
for _, object in ipairs({ToggleFrame, ToggleBtn}) do
    object.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1
            or input.UserInputType == Enum.UserInputType.Touch then
            
            beginDrag(input)

            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    endDrag()
                end
            end)
        end
    end)
end

-- Update posisi drag
UIS.InputChanged:Connect(function(input)
    if dragging then
        if input.UserInputType == Enum.UserInputType.MouseMovement
            or input.UserInputType == Enum.UserInputType.Touch then

            updateDrag(input)
        end
    end
end)
